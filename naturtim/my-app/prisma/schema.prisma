// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ========================================================================================================================================================
// SYSTEM I U呕YTKOWNICY - zarzdzanie u偶ytkownikami i logowanie zdarze
// ========================================================================================================================================================

model User {
  id Int @id @default(autoincrement())

  //logowanie
  login    String @unique
  password String

  //osoba
  username    String @default("default_username")
  userSurname String @default("default_surname")

  //daty tworzenia i aktualizacji
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  //dostepy
  permissions Permission[] @relation("UserPermissions")
}

//MODEL DOSTPU DO R呕NYCH MODUW
model Permission {
  id          Int    @id @default(autoincrement())
  name        String @unique
  href        String
  description String
  users       User[] @relation("UserPermissions")
}

// ========================================================================================================================================================
// MODELE PODSTAWOWE (SOWNIKI) - dane referencyjne
// ========================================================================================================================================================

model Product {
  id                Int               @id @default(autoincrement())
  name              String
  productionBatches ProductionBatch[]
}

model Supplier {
  id                Int               @id @default(autoincrement())
  name              String
  productionBatches ProductionBatch[]
}

model Recipient {
  id                Int               @id @default(autoincrement())
  name              String
  productionBatches ProductionBatch[]
}

model Machine {
  id                Int               @id @default(autoincrement())
  name              String
  color             String
  productionBatches ProductionBatch[]
}

model Fraction {
  id                 Int                 @id @default(autoincrement())
  name               String              @unique
  batchFractions     BatchFraction[]
  warehouseFractions WarehouseFraction[]
}

// ========================================================================================================================================================
// MODELE GWNE - operacje biznesowe
// ========================================================================================================================================================

model ProductionBatch {
  id Int @id @default(autoincrement())

  // ============================== ETAP 1: Przyjcie dostawy ==============================

  //Nadanie numeru partii (automatycznie)
  batchNumber String @unique

  // Produkt
  product   Product? @relation(fields: [productId], references: [id])
  productId Int?

  // Dostawca
  supplier   Supplier? @relation(fields: [supplierId], references: [id])
  supplierId Int?

  // Odbiorca
  recipient   Recipient? @relation(fields: [recipientId], references: [id])
  recipientId Int?

  // Data przyjcia
  deliveryDate DateTime? // Data przyjcia dostawy

  // Waga pocztkowa
  initialWeight Float? // Waga pocztkowa przy przyjciu

  // Automatyczne umieszczenie w magazynie mro藕ni
  mroznia Float? @default(0) // Aktualna waga w magazynie mro藕ni

  // Dodatkowe informacje
  notes String? // Notatki dotyczce przyjecia dostawy

  // ============================== ETAP 2: Harmonogram liofilizacji ==============================

  // Przypisanie maszyny
  machine   Machine? @relation(fields: [machineId], references: [id])
  machineId Int?

  // Planowanie procesu
  processPlannedStartDate DateTime? // Planowana data rozpoczcia z harmonogramu
  processPlannedEndDate   DateTime? // Planowana data zakoczenia z harmonogramu

  // ============================== ETAP 3: Proces liofilizacji ==============================

  // Faktyczne daty procesu
  processStartDate DateTime? // Faktyczna data rozpoczcia procesu
  processEndDate   DateTime? // Faktyczna data zakoczenia procesu

  // Wagi procesu
  processInputWeight  Float? // Waga wprowadzona do procesu
  processOutputWeight Float? // Waga po liofilizacji
  suchaMasa           Float? @default(0) // Wyliczona sucha masa

  // P贸produkt po liofilizacji, przed podziaem na frakcje
  polprodukt Float? @default(0) // Waga p贸produktu po liofilizacji (przed frakcjonowaniem) (DO USUNIECIA!) ************

  // ============================== ETAP 4: Podzia na frakcje ==============================

  // Relacja z frakcjami
  fractionItems BatchFraction[] // Przypisane frakcje dla tej partii

  // ============================== ETAP 5: Kontrola jakoci i produkt kocowy ==============================

  // Suma wszystkich gotowych produkt贸w po kontroli jakoci
  gotowyProdukt Float? @default(0) // czna waga wszystkich frakcji w magazynie produkt贸w gotowych (DO USUNIECIA!) ************

  // Liczba/waga karton贸w do wysyki
  kartony Float? @default(0)

  // ============================== ETAP 6: Obsuga zam贸wie ==============================

  warehouseFractions WarehouseFraction[]
}

// Model do obsugi frakcji przypisanych do partii
model BatchFraction {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  // Powizanie z parti
  batch   ProductionBatch @relation(fields: [batchId], references: [id])
  batchId Int

  // Powizanie z frakcj
  fraction   Fraction @relation(fields: [fractionId], references: [id])
  fractionId Int

  // Wagi dla frakcji w r贸偶nych magazynach
  polproduktWeight    Float @default(0) // Ile tej frakcji jest w p贸produktach
  gotowyProduktWeight Float @default(0) // Ile tej frakcji jest w gotowych produktach

  // Waga odpad贸w z tej frakcji (po kontroli jakoci)
  wasteWeight Float @default(0)

  // Data kontroli jakoci dla tej frakcji
  qualityControlDate DateTime?

  @@unique([batchId, fractionId])
}

// ========================================================================================================================================================
//  Logowanie zdarze - ledzenie wszystkich dziaa u偶ytkownik贸w
// ========================================================================================================================================================

model AuditLog {
  id          Int      @id @default(autoincrement())
  timestamp   DateTime @default(now())
  userId      Int
  userName    String // Imi i nazwisko u偶ytkownika
  description String // Np. "Doda dostaw ABC123", "Zmieni status partii z X na Y"
  details     String? // Opcjonalne szczeg贸y jako JSON (jeli potrzebne)
}

// ========================================================================================================================================================
//  Magazyny - przechowywanie frakcji w magazynach
// ========================================================================================================================================================

model Warehouse {
  id                 Int                 @id @default(autoincrement())
  name               String              @unique
  description        String?
  totalWeight        Float               @default(0)
  lastInventoryDate  DateTime            @default(now())
  warehouseFractions WarehouseFraction[]

  @@map("warehouses")
}

model WarehouseFraction {
  id                Int   @id @default(autoincrement())
  warehouseId       Int
  fractionId        Int
  productionBatchId Int?
  weight            Float @default(0)

  warehouse       Warehouse        @relation(fields: [warehouseId], references: [id])
  fraction        Fraction         @relation(fields: [fractionId], references: [id])
  productionBatch ProductionBatch? @relation(fields: [productionBatchId], references: [id])

  @@map("warehouse_fractions")
}
